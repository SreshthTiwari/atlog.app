<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../styling/common.css" />
    <!-- <link rel="stylesheet" href="../styling/student.css" /> -->
    <link rel="stylesheet" href="../styling/home.css" />
    <link
      href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css"
      rel="stylesheet"
    />
    <script
      type="text/javascript"
      src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"
    ></script>
    <link rel="icon" type="image/x-icon" href="../images/logo.png" />
    <title>@Log - Dashboard</title>
  </head>
  <body>
    <nav class="sidebar">
      <header>
        <div class="image-text">
          <span class="image">
            <img src="../images/logoo.png" alt="" />
          </span>

          <div class="text logo-text">
            <span class="name">Admin Page</span>
            <!-- <span class="profession">Web developer</span> -->
          </div>
        </div>

        <!-- <i class="bx bx-chevron-right toggle"></i> -->
      </header>

      <div class="menu-bar">
        <div class="menu">
          <ul class="menu-links">
            <li class="nav-link">
              <a href="#">
                <i class="bx bx-home-alt icon"></i>
                <span class="text nav-text">Dashboard</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/buses.html">
                <i class="bx bxs-bus-school icon"></i>
                <span class="text nav-text">Buses Info</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/students.html">
                <i class="bx bx-bar-chart-alt-2 icon"></i>
                <span class="text nav-text">Student Info</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/carer.html">
                <i class="bx bx-list-ul icon"></i>
                <span class="text nav-text">Carer Info</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/help.html">
                <i class="bx bx-question-mark icon"></i>
                <span class="text nav-text">Help</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="bottom-content">
          <li class="logoutt">
            <a href="#" id="logout">
              <i class="bx bx-log-out icon"></i>
              <span class="text nav-text logouttext">Logout</span>
            </a>
          </li>
        </div>
      </div>
    </nav>
    <div class="warning">
      <h1>Your device width is too low</h1>
      <h2>Kindly login through a PC or another device</h2>
    </div>
    <div class="home">
      <div class="User">
        <div class="text">
          <h1>Dashboard</h1>
          <h2>Euroschool North Campus</h2>
        </div>
        <div class="plan">
          <i class="bx bxs-user"></i>
          <div class="texttt">
            <h2>
              Backend <br />
              Website
            </h2>
            <!-- <a href="#">Upgrade</a> -->
          </div>
        </div>
      </div>
      <div class="insights">
        <div class="col" onclick="bus()">
          <div class="textt">
            <h1 id="buses">0</h1>
            <h3>Buses</h3>
          </div>
          <div class="icon">
            <i class="bx bxs-bus-school"></i>
          </div>
        </div>
        <div class="col" onclick="student()">
          <div class="textt">
            <h1 id="students">0</h1>
            <h3>Students</h3>
          </div>
          <div class="icon">
            <i class="bx bxs-group"></i>
          </div>
        </div>
        <div class="col" onclick="carer()">
          <div class="textt">
            <h1 id="carers">0</h1>
            <h3>Carers</h3>
          </div>
          <div class="icon">
            <i class="bx bx-female"></i>
          </div>
        </div>
      </div>
      <div class="last">
        <div class="main">
          <div class="text">Attendance Data</div>
          <div class="route">
            Route:
            <select name="route" id="routeno">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="21">21</option>
              <option value="22">22</option>
              <option value="23">23</option>
              <option value="24">24</option>
              <option value="25">25</option>
              <option value="26">26</option>
            </select>
            Date:
            <input type="date" id="datee" />
            <button class="addbutton" onclick="excell()">Download Data</button>
          </div>
          <div class="info" id="info">
            <table id="studentinfo">
              <tr>
                <th>Pickup</th>
                <th>Name</th>
                <th>Current</th>
                <th>Morning</th>
                <th>Evening</th>
              </tr>
              <tbody id="tbody1"></tbody>
            </table>
            <div class="loadingdiv" id="loadingdiv"></div>
            <div id="noattendance">
              <h1>Attendance for this date has not been marked</h1>
              <h3>Think this is an error?</h3>
              <a href="help.html">Tell Us</a>
            </div>
          </div>
          <div class="excelmenu homeexcel" id="excelmenu">
            <div class="wrapperr">
              <h3>Extract Excel File</h3>
              <div class="buttons">
                <button class="excelbutton" onclick="downloadexcel()">
                  Download Data
                </button>
                <button class="excelbutton" onclick="cancelexcel()">
                  Close
                </button>
              </div>
              <div class="down">
                <p>Note: This will download data of the selected date</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="next">
        <div class="breakdown">
          <!-- <div id="chart_div" class="graphh"></div> -->
          <h1>Bus Status</h1>
          <div class="working">
            <h3>All Buses are properly working</h3>
            <a href="./buses.html">More Information</a>
          </div>
          <!-- <div class="breakdownalert">
            <h3 id="busbroke">Alert! Route no. 5 has broken down</h3>
            <a href="./buses.html">Location</a>
          </div> -->
        </div>
        <div class="other">
          <div class="mto">
            <div class="container">
              <div class="circular-progress">
                <span class="progress-value"></span>
              </div>
            </div>
            <div class="othertext">
              <h1>23/1000</h1>
              <h3>Days completed</h3>
            </div>
          </div>
          <div class="shortcuts">
            <div class="text">
              <h1>Shortcuts</h1>
            </div>
            <div class="icons">
              <div class="download aa">
                <div class="tooltip">
                  <span class="tttext">Student Data</span>
                </div>
                <a href="./students.html"><i class="bx bxs-download"></i></a>
              </div>
              <div class="contact aa">
                <div class="tooltip"><span class="tttext">Contact</span></div>
                <a href="./help.html"><i class="bx bx-envelope"></i></a>
              </div>
              <div class="addcarer aa">
                <div class="tooltip"><span class="tttext">Add Carer</span></div>
                <a href="./carer.html"><i class="bx bx-plus-medical"></i></a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <h3>@Log</h3>
        <p>Page End</p>
      </div>
    </div>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <script type="text/javascript">
      function bus() {
        window.location.href = "../pages/buses.html";
      }
      function student() {
        window.location.href = "../pages/students.html";
      }
      function carer() {
        window.location.href = "../pages/carer.html";
      }
      let circularProgress = document.querySelector(".circular-progress"),
        progressValue = document.querySelector(".progress-value");

      let progressStartValue = 0,
        progressEndValue = 90,
        speed = 100;

      let progress = setInterval(() => {
        progressStartValue++;

        progressValue.textContent = `${progressStartValue}%`;
        circularProgress.style.background = `conic-gradient(white ${
          progressStartValue * 3.6
        }deg, #ffffff05 0deg)`;

        if (progressStartValue == progressEndValue) {
          clearInterval(progress);
        }
      }, 20);
      var nstds = setInterval(studentsss, 4);
      var cnarers = setInterval(carersss, 100);
      var bunses = setInterval(busesss, 100);
      let count1 = 1;
      let count2 = 1;
      let count3 = 1;

      var stds = document.getElementById("students");
      var carers = document.getElementById("carers");
      var buses = document.getElementById("buses");

      function studentsss() {
        count1++;
        stds.innerHTML = count1;
        if (count1 == 784) {
          clearInterval(nstds);
        }
      }
      function carersss() {
        count2++;
        carers.innerHTML = count2;
        if (count2 == 30) {
          clearInterval(cnarers);
        }
      }
      function busesss() {
        count3++;
        buses.innerHTML = count3;
        if (count3 == 26) {
          clearInterval(bunses);
        }
      }
    </script>
    <script type="module">
      import {
        getAuth,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-auth.js";

      import {
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-database.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
      import {
        getDatabase,
        set,
        get,
        child,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyAKQ7x0iXdc9zPASPl8fe0Zy3w977sslwQ",
        authDomain: "schooltransportthingtest.firebaseapp.com",
        databaseURL:
          "https://schooltransportthingtest-default-rtdb.firebaseio.com",
        projectId: "schooltransportthingtest",
        storageBucket: "schooltransportthingtest.appspot.com",
        messagingSenderId: "1022909830472",
        appId: "1:1022909830472:web:14e6c0005a15bcfbed4f7d",
        measurementId: "G-9477HH598G",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth();

      //log out user if not signed in
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("user signed in");
        } else {
          console.log("user not signed in");
          window.location.href = "../index.html";
        }
      });

      const route = document.getElementById("routeno");

      var editform = document.getElementById("editform");
      var addmenu = document.getElementById("addmenu");
      var excelmenu = document.getElementById("excelmenu");

      var stuno = "";

      window.contact = function contacttt() {
        console.log("sdafkjas");
      };

      window.add = function add() {
        addmenu.style.display = "block";
      };

      window.cancelexcel = function cancelexcel() {
        excelmenu.style.display = "none";
      };

      window.excell = function excell() {
        console.log("this work");
        excelmenu.style.display = "block";
      };

      window.downloadexcel = function downloadexcel() {
        var date = document.getElementById("datee").value;
        var myrouteno = route.options[route.selectedIndex].text;

        console.log("this should download excel");
        var tablee = document.getElementById("studentinfo");

        var excelFile = XLSX.utils.table_to_book(tablee, { sheet: "sheet1" });
        XLSX.write(excelFile, {
          bookType: "xlsx",
          bookSST: true,
          type: "base64",
        });
        XLSX.writeFile(
          excelFile,
          "routeno_" + myrouteno + "_studentdata_" + date + ".xlsx"
        );
      };

      var logoutlink = document.getElementById("logout");

      var tbody = document.getElementById("tbody1");

      var dateinput = document.getElementById("datee");
      var today = new Date();
      dateinput.value = today.toISOString().substring(0, 10);

      function addtotable(pickup, inbus, mat, name) {
        let trow = document.createElement("tr");
        let tdd = document.createElement("td");
        let td1 = document.createElement("td");
        let td2 = document.createElement("td");
        let td3 = document.createElement("td");
        let td4 = document.createElement("td");

        td4.innerHTML = pickup;
        tdd.innerHTML = name;

        if (inbus) {
          td1.innerHTML = "In Bus";
        } else {
          td1.innerHTML = "Out of Bus";
        }
        if (mat) {
          td2.innerHTML = "Present";
        } else {
          td2.innerHTML = "Absent/OT";
        }
        // if (eat) {
        //   td3.innerHTML = "Present";
        // } else {
        //   td3.innerHTML = "Absent/OT";
        // }
        td3.innerHTML = td2.innerHTML;

        trow.appendChild(td4);
        trow.appendChild(tdd);
        trow.appendChild(td1);
        trow.appendChild(td2);
        trow.appendChild(td3);

        tbody.appendChild(trow);
        loader.style.display = "none";
      }
      var todel = document.getElementById("noattendance");

      function addalltotable(student) {
        tbody.innerHTML = "";
        // var errorr = false;
        try {
          var lengthofobj = student.length;
          var errorr = false;
        } catch (error) {
          var errorr = true;
          var errormessage = error;
        }
        if (
          errorr &&
          errormessage ==
            "TypeError: Cannot read properties of undefined (reading 'length')"
        ) {
          // alert("Attendance for the selected date has not been completed");
          loader.style.display = "none";
          todel.style.display = "block";
          return false;
        }
        if (!errorr) {
          for (let index = 0; index < lengthofobj - 1; index++) {
            const element = student[index];
            console.log(element);
            addtotable(
              index + 1,
              // element.eveningAttendance,
              element.inBus,
              element.morningAttendance,
              element.name
            );
          }
        }
      }

      var loader = document.getElementById("loadingdiv");

      route.onchange = getdata;
      document.getElementById("datee").onchange = getdata;

      function getdata() {
        // var newerr = false;
        // try {
        //   var todel = document.getElementById("noattendance");
        //   newerr = false;
        // } catch (error) {
        //   newerr = true;
        //   console.log("ER");
        // }
        // if (!newerr) {
        //   todel.remove();
        // }
        if (todel) {
          todel.style.display = "none";
        }

        const dbref = ref(db);
        var date = document.getElementById("datee").value;

        get(
          child(
            dbref,
            "Attendance/"
              .concat(date)
              .concat("/")
              .concat(route.options[route.selectedIndex].text)
          )
        ).then((snapshot) => {
          var students = [];
          snapshot.forEach((childsnap) => {
            students.push(childsnap.val());
          });
          console.log(students);
          addalltotable(students);
        });
        onValue(dbref, (snapshot) => {
          var dateee = document.getElementById("datee").value;
          console.log(dateee);
          var students = [];
          snapshot.forEach((childsnap) => {
            students.push(childsnap.val());
          });
          console.log(students[0][dateee]);
          var myrouteno = route.options[route.selectedIndex].text;
          addalltotable(students[0][dateee]);
        });
      }

      window.onload = getdata;

      logoutlink.addEventListener("click", function () {
        const auth = getAuth();
        signOut(auth)
          .then(() => {})
          .catch((error) => {
            alert("error");
          });
      });
    </script>
  </body>
</html>
